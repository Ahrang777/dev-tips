# Spring Cloud Data Flow with k8s

k8s Í∏∞Î∞ò Spring Cloud Data Flow Ïã§Ïäµ ÏûêÎ£åÏù∏ https://dataflow.spring.io/getting-started/ ÏóêÏÑú k8s ÌîåÎû´Ìèº Í∏∞Ï§Ä ÎÇ¥Ïö© ÏöîÏïΩ Î∞è Ïã§Ï†ú Ïã§Ìñâ ÎÇ¥Ïö© Ï∂îÍ∞Ä

# Install k8s

k8sÎ•º Î°úÏª¨ÏóêÏÑú Íµ¨ÏÑ±ÌïòÎäî Îç∞ ÏÇ¨Ïö©ÌïòÎäî ÎèÑÍµ¨ÎèÑ Ïó¨Îü¨Í∞ÄÏßÄÍ∞Ä ÏûàÎã§.


Î†àÌçºÎü∞Ïä§ Î¨∏ÏÑúÎäî minikube Í∏∞Ï§ÄÏúºÎ°ú Îèº ÏûàÏßÄÎßå,  
[Í¥ÄÎ†® ÏûêÎ£å](https://medium.com/dev-genius/kubernetes-for-local-development-a6ac19f1d1b2) Í≤ÄÌÜ† Í≤∞Í≥º,  
multiple node cluster Í∞ÄÎä•Ìïú Kind(K8s INside Docker) ÏÑ†ÌÉù

## Kind

k8s Î°úÏª¨ Íµ¨ÏÑ± ÏßÄÏõê ÎèÑÍµ¨

### ÏÑ§Ïπò

https://kind.sigs.k8s.io/docs/user/quick-start/

>brew install kind

```
...
==> Summary
üç∫  /usr/local/Cellar/kind/0.9.0: 8 files, 9.2MB
```

ÌÅ¥Îü¨Ïä§ÌÑ∞Í∞Ä ÏÉùÏÑ± Ï†ÑÏóêÎäî `~/.kube/config` ÌååÏùºÏùò ÎÇ¥Ïö©Ïù¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ Í±∞Ïùò ÎπÑÏñ¥ ÏûàÎã§.

```
apiVersion: v1                                                       
kind: Config
preferences: {}
```

### ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÉùÏÑ± Î∞è Ïã§Ìñâ

3-node(1 control + 2 worker) ÌÅ¥Îü¨Ïä§ÌÑ∞ Î™®ÎìúÎ°ú Ïã§Ìñâ

https://kind.sigs.k8s.io/docs/user/quick-start/#advanced

```yml
kind-minimal-cluster-example-config.yml

# three node (two workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
```

>kind create cluster --config kind-minimal-cluster-example-config.yml --name my-k8s-cluster

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kind create cluster --config kind-minimal-cluster-example-config.yml --name my-k8s-cluster
Creating cluster "my-k8s-cluster" ...
 ‚úì Ensuring node image (kindest/node:v1.19.1) üñº 
 ‚úì Preparing nodes üì¶ üì¶ üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
 ‚úì Joining worker nodes üöú 
Set kubectl context to "kind-my-k8s-cluster"
You can now use your cluster with:

kubectl cluster-info --context kind-my-k8s-cluster

Not sure what to do next? üòÖ  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏÉùÏÑ± ÌõÑ `~/.kube/config` ÌååÏùº ÎÇ¥Ïö©Ïù¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ Ï±ÑÏõåÏßÑÎã§.

```
apiVersion: v1                                                                                                                                                                    
clusters:
- cluster:
    certificate-authority-data: XXX...ÏÉùÎûµ...
    server: https://127.0.0.1:58878
  name: kind-my-k8s-cluster
contexts:
- context:
    cluster: kind-my-k8s-cluster
    user: kind-my-k8s-cluster
  name: kind-my-k8s-cluster
current-context: kind-my-k8s-cluster
kind: Config
preferences: {}
users:
- name: kind-my-k8s-cluster
  user:
    client-certificate-data: YYY...ÏÉùÎûµ...
```

>kubectl cluster-info --context kind-my-k8s-cluster

```
Kubernetes master is running at https://127.0.0.1:58878
KubeDNS is running at https://127.0.0.1:58878/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```

### ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï¢ÖÎ£å

>kind delete cluster --name my-k8s-cluster

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kind delete cluster --name my-k8s-cluster
Deleting cluster "my-k8s-cluster" ...
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all
The connection to the server localhost:8080 was refused - did you specify the right host or port?
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

Ï¢ÖÎ£å ÌõÑ `~/.kube/config` ÌååÏùº ÎÇ¥Ïö©ÏùÄ Îã§Ïãú Ï¥àÍ∏∞ÌôîÎêúÎã§.

```
apiVersion: v1                                                       
kind: Config
preferences: {}
```


## kubectl ÏÑ§Ïπò

kindÍ∞Ä kubectlÏùÑ Î∞òÎìúÏãú ÌïÑÏöîÎ°ú ÌïòÏßÑ ÏïäÏßÄÎßå Ïó¨Îü¨ ÏòàÏ†úÍ∞Ä kubectlÏùÑ ÏÇ¨Ïö©ÌïòÎØÄÎ°ú ÏÑ§Ïπò

https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos

>brew install kubectl

```
...
==> Summary
üç∫  /usr/local/Cellar/kubernetes-cli/1.20.1: 246 files, 46.1MB
```


## ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï†ïÎ≥¥ ÌôïÏù∏ 

>kubectl cluster-info --context kind-kind

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl cluster-info --context kind-my-k8s-cluster
Kubernetes master is running at https://127.0.0.1:58878
KubeDNS is running at https://127.0.0.1:58878/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

`https://127.0.0.1:58878`Ïóê Ï†ëÏÜçÌïòÎ©¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ 403 Ïù∏Ï¶ù ÏóêÎü¨ Î∞úÏÉù. ÏùºÎã® ÎÑòÏñ¥Í∞ê

```
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {
    
  },
  "status": "Failure",
  "message": "forbidden: User \"system:anonymous\" cannot get path \"/\"",
  "reason": "Forbidden",
  "details": {
    
  },
  "code": 403
}
```

`kubectl cluster-info dump`Î•º Ïã§ÌñâÌïòÎ©¥ ÏóÑÏ≤≠ÎÇú ÏñëÏùò Ï†ïÎ≥¥Í∞Ä Ï∂úÎ†•Îê®


# k8s Íµ¨ÏÑ± ÌååÏùº

kubectlÎ°ú Î∞∞Ìè¨ÎêòÎäî Ïó¨Îü¨ Ïª¥Ìè¨ÎÑåÌä∏Ïùò yml ÌååÏùºÏù¥ gitÏóê ÏûàÏñ¥ÏÑú cloneÏúºÎ°ú Í∞ÄÏ†∏Ïò¥

## git repo clone

>git clone https://github.com/spring-cloud/spring-cloud-dataflow  
>cd spring-cloud-dataflow  
>git checkout v2.7.0



# k8s-SCDF Íµ¨ÏÑ±

ÌÅ¨Í≤å Îã§Ïùå 5Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú Íµ¨ÏÑ±

- Message Broker
- Database
- Monitoring
- SCDF



# Meesage Broker

RabbitMQÏôÄ Kafka Ï§ë [ÏÑ†ÌÉù](https://dataflow.spring.io/docs/installation/kubernetes/kubectl/#choose-a-message-broker), Ïó¨Í∏∞ÏóêÏÑúÎäî RabbitMQ ÏÑ†ÌÉù

## RabbitMQ

### Î∞∞Ìè¨

`src/kubernetes/rabbitmq/rabbit-svc.yaml` ÌååÏùºÏùÑ Ïó¥Ïñ¥Î≥¥Î©¥ rabbitmq ÏÑúÎπÑÏä§Ïùò ÌÉÄÏûÖÏùÄ ÏßÄÏ†ïÎèºÏûàÏßÄ ÏïäÎã§.

>kubectl create -f src/kubernetes/rabbitmq

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/rabbitmq
deployment.apps/rabbitmq created
service/rabbitmq created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all -l app=rabbitmq

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all -l app=rabbitmq                                                                                              ‚úπ ‚ú≠
NAME                            READY   STATUS    RESTARTS   AGE
pod/rabbitmq-78b6c44c49-bpln4   1/1     Running   0          77s

NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/rabbitmq   ClusterIP   10.96.135.124   <none>        5672/TCP   77s

NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/rabbitmq   1/1     1            1           77s

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/rabbitmq-78b6c44c49   1         1         1       77s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all -l app=rabbitmq



# Database

MySQL, Postgres, H2 Ï§ë ÏÑ†ÌÉù

## MySQL

### Î∞∞Ìè¨

`src/kubernetes/mysql/mysql-svc.yaml` ÌååÏùºÏùÑ Ïó¥Ïñ¥Î≥¥Î©¥ rabbitmq ÏÑúÎπÑÏä§Ïùò ÌÉÄÏûÖÏùÄ ÏßÄÏ†ïÎèºÏûàÏßÄ ÏïäÎã§.

>kubectl create -f src/kubernetes/mysql/

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/mysql/
deployment.apps/mysql created
persistentvolumeclaim/mysql created
secret/mysql created
service/mysql created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all -l app=mysql

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all -l app=mysql
NAME                         READY   STATUS    RESTARTS   AGE
pod/mysql-58f79dbc8c-n7slk   1/1     Running   0          31s

NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/mysql   ClusterIP   10.96.183.164   <none>        3306/TCP   31s

NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/mysql   1/1     1            1           31s

NAME                               DESIRED   CURRENT   READY   AGE
replicaset.apps/mysql-58f79dbc8c   1         1         1       31s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,pvc,secrets -l app=mysql



# Monitoring

PrometheusÎ°ú ÏßÄÌëú ÏàòÏßë, Grafana ÎåÄÏãúÎ≥¥Îìú ÏÇ¨Ïö©

Î¨∏ÏÑúÏóêÎäî WaveFrontÎèÑ ÎÇòÏò§ÏßÄÎßå Ïò§Ìîà ÏÜåÏä§Í∞Ä ÏïÑÎãàÎ©∞ ÏÑ†ÌÉùÏù∏ ÎìØ Ìï¥ÏÑú skip

## Prometheus

Î™®ÎãàÌÑ∞ÎßÅ ÏßÄÌëú ÏàòÏßëÏùÑ ÏúÑÌï¥ Prometheus Î∞∞Ìè¨

### prometheus-proxy Î∞∞Ìè¨

`src/kubernetes/prometheus-proxy/prometheus-proxy-service.yaml`Î•º Ïó¥Ïñ¥Î≥¥Î©¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ ÌÉÄÏûÖÏù¥ `LoadBalancer`Î°ú ÏßÄÏ†ïÎèº ÏûàÎã§.

```
apiVersion: v1                                      
kind: Service
metadata:
  name: prometheus-proxy
  labels:
    app: prometheus-proxy
spec:
  selector:
    app: prometheus-proxy
  ports:
    - name: scrape
      port: 8080
      targetPort: 8080
    - name: rsocket
      port: 7001
      targetPort: 7001
  # type: LoadBalancer
  type: NodePort
```

Ïô∏Î∂Ä ÌÅ¥ÎùºÏö∞Îìú Ï†úÍ≥µÏûêÏùò Î°úÎìúÎ∞∏Îü∞ÏÑúÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏßÄ ÏïäÏúºÎØÄÎ°ú `LoadBalancer`Î•º `NodePort`Î°ú ÎåÄÏ≤¥ÌïúÎã§.

>kubectl create -f src/kubernetes/prometheus-proxy/

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/prometheus-proxy
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRoleBinding is deprecated in v1.17+, unavailable in v1.22+; use rbac.authorization.k8s.io/v1 ClusterRoleBinding
clusterrolebinding.rbac.authorization.k8s.io/prometheus-proxy created
deployment.apps/prometheus-proxy created
service/prometheus-proxy created
serviceaccount/prometheus-proxy created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### prometheus-proxy Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all -l app=prometheus-proxy

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all -l app=prometheus-proxy
NAME                                    READY   STATUS    RESTARTS   AGE
pod/prometheus-proxy-5b958c7fd4-xk5lq   1/1     Running   0          24m

NAME                       TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                         AGE
service/prometheus-proxy   NodePort   10.96.20.147   <none>        8080:32036/TCP,7001:31986/TCP   95s

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus-proxy   1/1     1            1           24m

NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/prometheus-proxy-5b958c7fd4   1         1         1       24m
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

ÏÑúÎπÑÏä§Ïùò ÎÑ§Ìä∏ÏõåÌÅ¨Îäî Îã§ÏùåÍ≥º Í∞ôÏù¥ ÌôïÏù∏ Í∞ÄÎä•ÌïòÎã§.

>kubectl describe services/prometheus-proxy

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl describe services/prometheus-proxy
Name:                     prometheus-proxy
Namespace:                default
Labels:                   app=prometheus-proxy
Annotations:              <none>
Selector:                 app=prometheus-proxy
Type:                     NodePort
IP:                       10.96.20.147
Port:                     scrape  8080/TCP
TargetPort:               8080/TCP
NodePort:                 scrape  32036/TCP
Endpoints:                10.244.1.3:8080
Port:                     rsocket  7001/TCP
TargetPort:               7001/TCP
NodePort:                 rsocket  31986/TCP
Endpoints:                10.244.1.3:7001
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### prometheus-proxy Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,cm,svc -l app=prometheus-proxy

### prometheus Î∞∞Ìè¨

>kubectl create -f src/kubernetes/prometheus/prometheus-configmap.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/prometheus/prometheus-configmap.yaml
configmap/prometheus created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

>kubectl create -f src/kubernetes/prometheus/prometheus-deployment.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/prometheus/prometheus-deployment.yaml
deployment.apps/prometheus created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

`src/kubernetes/prometheus/prometheus-service.yaml` ÌååÏùºÏùÑ Ïó¥Ïñ¥Î≥¥Î©¥ prometheus ÏÑúÎπÑÏä§Ïùò ÌÉÄÏûÖÏùÄ ÏßÄÏ†ïÎèºÏûàÏßÄ ÏïäÎã§.

>kubectl create -f src/kubernetes/prometheus/prometheus-service.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/prometheus/prometheus-service.yaml
service/prometheus created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### prometheus Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all -l app=prometheus

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all -l app=prometheus
NAME                              READY   STATUS    RESTARTS   AGE
pod/prometheus-7fbc58dcf5-24bvv   1/1     Running   0          20s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/prometheus   ClusterIP   10.96.87.216   <none>        9090/TCP   11s

NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus   1/1     1            1           20s

NAME                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/prometheus-7fbc58dcf5   1         1         1       20s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### prometheus Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,cm,svc -l app=prometheus


## Grafana

### Î∞∞Ìè¨

`src/kubernetes/grafana/grafana-service.yaml`Î•º Ïó¥Ïñ¥Î≥¥Î©¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ ÌÉÄÏûÖÏù¥ `LoadBalancer`Î°ú ÏßÄÏ†ïÎèº ÏûàÎäîÎç∞, Ïô∏Î∂Ä ÌÅ¥ÎùºÏö∞Îìú Ï†úÍ≥µÏûêÏùò Î°úÎìúÎ∞∏Îü∞ÏÑúÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏßÄ ÏïäÏúºÎØÄÎ°ú `LoadBalancer`Î•º `NodePort`Î°ú ÎåÄÏ≤¥ÌïúÎã§.

```
apiVersion: v1                                                              
kind: Service
metadata:
  name: grafana
  labels:
    app: grafana
spec:
  selector:
    app: grafana
  # type: LoadBalancer
  type: NodePort
  ports:
    - port: 3000
      targetPort: 3000
```

>kubectl create -f src/kubernetes/grafana/

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/grafana/
configmap/grafana created
deployment.apps/grafana created
secret/grafana created
service/grafana created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all -l app=grafana

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all -l app=grafana
NAME                           READY   STATUS    RESTARTS   AGE
pod/grafana-7dc7d95456-bhj6l   1/1     Running   0          43s

NAME              TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/grafana   NodePort   10.96.116.14   <none>        3000:30050/TCP   43s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana   1/1     1            1           43s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/grafana-7dc7d95456   1         1         1       43s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,cm,svc,secrets -l app=grafana


# SCDF

## prometheus-proxy Í¥ÄÎ†® ÏÑ§Ï†ï

PrometheusÍ∞Ä Data Flow ÏÑúÎ≤ÑÏôÄ Skipper ÏÑúÎ≤Ñ ÏßÄÌëúÎ•º ÏàòÏßëÌï† Ïàò ÏûàÎèÑÎ°ù ÏÑ§Ï†ïÌï¥Ï§òÏïº ÌïúÎã§.

Data Flow ÏÑúÎ≤Ñ ÏÑ§Ï†ï ÌååÏùº `src/kubernetes/server/server-config.yaml`ÏóêÎäî Ïù¥ÎØ∏ PrometheusÍ∞Ä Íµ¨ÏÑ±Îèº ÏûàÍ≥†, Skipper ÏÑúÎ≤Ñ ÏÑ§Ï†ï ÌååÏùºÏóêÎäî Íµ¨ÏÑ±Îèº ÏûàÏßÄ ÏïäÎã§. Îî∞ÎùºÏÑú `src/kubernetes/server/server-config.yaml` ÎÇ¥Ïö© Ï∞∏Í≥†Ìï¥ÏÑú ÏïÑÎûòÏôÄ Í∞ôÏù¥ Skipper ÏÑúÎ≤Ñ ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌïòÎ©¥ ÎêúÎã§.

`src/kubernetes/skipper/skipper-config-{kafka|rabbit}.yaml` ÌååÏùºÏóê ÏïÑÎûò `management` ÎÇ¥Ïö©ÏùÑ `data > application.yaml`ÏïÑÎûòÏóê Ï∂îÍ∞ÄÌïúÎã§.

```
data:
  application.yaml: |-
    ...
    management:
      metrics:
        export:
          prometheus:
            enabled: true
            rsocket:
              enabled: true
              host: prometheus-proxy
              port: 7001
...
```

## grafana Í¥ÄÎ†® ÏÑ§Ï†ï

### grafana Endpoint ÌôïÏù∏

>kubectl describe service/grafana

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl describe service/grafana                                                                                             ‚úπ ‚ú≠
Name:                     grafana
Namespace:                default
Labels:                   app=grafana
Annotations:              <none>
Selector:                 app=grafana
Type:                     NodePort
IP:                       10.96.116.14
Port:                     <unset>  3000/TCP
TargetPort:               3000/TCP
NodePort:                 <unset>  30050/TCP
Endpoints:                10.244.2.7:3000
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

grafana ÏÑúÎπÑÏä§Ïùò EndpointsÏóê ÌëúÏãúÎêú IP, PORT Í∞íÏùÑ Data Flow ÏÑúÎ≤Ñ ÏÑúÎπÑÏä§ ÏÑ§Ï†ï ÌååÏùºÏù∏ `src/kubernetes/server/server-config.yaml`Ïùò dashboard urlÏóê Îã§ÏùåÍ≥º Í∞ôÏù¥ ÏßÄÏ†ïÌïúÎã§. Ïù¥Î†áÍ≤å Ìï¥Ïïº ÎÇòÏ§ëÏóê Ïõπ Î∏åÎùºÏö∞Ï†ÄÎ•º ÌÜµÌï¥ grafana ÎåÄÏãúÎ≥¥ÎìúÏóê Ï†ëÍ∑ºÌï† Ïàò ÏûàÎã§.

```
...
    spring:
      cloud:
        dataflow:
          metrics.dashboard:
            # url: 'https://grafana:3000'
            url: 'https://10.244.2.7:3000'
...
```

## SCDF Role, Binding, Service Account

### Role

>kubectl create -f src/kubernetes/server/server-roles.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/server-roles.yaml
role.rbac.authorization.k8s.io/scdf-role created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Role Binding

>kubectl create -f src/kubernetes/server/server-rolebinding.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/server-rolebinding.yaml
Warning: rbac.authorization.k8s.io/v1beta1 RoleBinding is deprecated in v1.17+, unavailable in v1.22+; use rbac.authorization.k8s.io/v1 RoleBinding
rolebinding.rbac.authorization.k8s.io/scdf-rb created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### Role Binding ÌôïÏù∏

>kubectl get roles

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get roles
NAME        CREATED AT
scdf-role   2020-12-27T09:29:28Z
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### Service Account

>kubectl create -f src/kubernetes/server/service-account.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/service-account.yaml
serviceaccount/scdf-sa created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

### Service Account ÌôïÏù∏

>kubectl get sa

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get sa
NAME               SECRETS   AGE
default            1         5h54m
prometheus         1         43m
prometheus-proxy   1         4h30m
scdf-sa            1         43s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Role, Binding, Service Account Î∞∞Ìè¨ ÌöåÏàò 

>kubectl delete role scdf-role
>
>kubectl delete rolebinding scdf-rb
>
>kubectl delete serviceaccount scdf-sa


## Skipper ÏÑúÎ≤Ñ

2020-12-27 ÌòÑÏû¨ SCDF Î≤ÑÏ†ÑÏùÄ 2.7.0 Ïù¥ÏßÄÎßå ÏïÑÎûòÏôÄ Í∞ôÏù¥ Skipper ÏÑúÎ≤Ñ ÏµúÏã† Ïù¥ÎØ∏ÏßÄÎäî 2.6.0 Ïù¥Î©∞, 

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ docker images springcloud/spring-cloud-skipper-server      
REPOSITORY                                TAG       IMAGE ID       CREATED       SIZE
springcloud/spring-cloud-skipper-server   2.6.0     d7eba9aa59f8   4 weeks ago   389MB
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

`src/kubernetes/skipper/skipper-deployment.yaml` ÌååÏùºÏóêÎèÑ 2.6.0 ÏúºÎ°ú Îèº ÏûàÎã§.

```
...
spec:
  selector:
    matchLabels:
      app: skipper
  replicas: 1
  template:
    metadata:
      labels:
        app: skipper
    spec:
      containers:
      - name: skipper
        image: springcloud/spring-cloud-skipper-server:2.6.0  #
...
```

### Skipper-RabbitMQ Î∞∞Ìè¨

>kubectl create -f src/kubernetes/skipper/skipper-config-rabbit.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/skipper/skipper-config-rabbit.yaml
configmap/skipper created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Skipper ÏÑúÎ≤Ñ Î∞∞Ìè¨

>kubectl create -f src/kubernetes/skipper/skipper-deployment.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/skipper/skipper-deployment.yaml
deployment.apps/skipper created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

`src/kubernetes/skipper/skipper-svc.yaml`Î•º Ïó¥Ïñ¥Î≥¥Î©¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ ÌÉÄÏûÖÏù¥ `LoadBalancer`Î°ú ÏßÄÏ†ïÎèº ÏûàÎäîÎç∞, Ïô∏Î∂Ä ÌÅ¥ÎùºÏö∞Îìú Ï†úÍ≥µÏûêÏùò Î°úÎìúÎ∞∏Îü∞ÏÑúÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏßÄ ÏïäÏúºÎØÄÎ°ú `LoadBalancer`Î•º `NodePort`Î°ú ÎåÄÏ≤¥ÌïúÎã§.

```
apiVersion: v1
kind: Service
metadata:
  name: skipper
  labels:
    app: skipper
    spring-deployment-id: scdf
spec:
  # If you are running k8s on a local dev box, using minikube, or Kubernetes on docker desktop you can use type NodePort instead
  # type: LoadBalancer
  type: NodePort                                                                                                 
  ports:
  - port: 80
    targetPort: 7577
  selector:
    app: skipper
```

>kubectl create -f src/kubernetes/skipper/skipper-svc.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/skipper/skipper-svc.yaml
service/skipper created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Skipper ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all,cm -l app=skipper

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all,cm -l app=skipper
NAME                           READY   STATUS    RESTARTS   AGE
pod/skipper-54d985cd5b-nd6wn   1/1     Running   0          20m

NAME              TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE
service/skipper   NodePort   10.96.89.15   <none>        80:31353/TCP   3s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/skipper   1/1     1            1           20m

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/skipper-54d985cd5b   1         1         1       20m

NAME                DATA   AGE
configmap/skipper   1      12m
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ   
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### Skipper ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,cm -l app=skipper


## Data Flow ÏÑúÎ≤Ñ

Íµ¨ÏÑ± ÌååÏùºÏùÄ `src/kubernetes/server/server-deployment.yaml`Ïóê ÏûàÏúºÎ©∞, Í∏∞Î≥∏ Î≤ÑÏ†ÑÎèÑ 2.7.0 ÏúºÎ°ú ÎèºÏûàÏñ¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©

Skipper ÏÑúÎ≤ÑÍ∞Ä Î®ºÏ†Ä Íµ¨ÎèôÎêòÍ≥† ÏûàÏñ¥Ïïº ÌïòÎ©∞, Skipper ÏÑúÎ≤ÑÏùò IP, PORTÎ•º `src/kubernetes/server/server-deployment.yaml` ÌååÏùºÏóê ÏïÑÎûòÏôÄ Í∞ôÏù¥ ÏßÄÏ†ïÌï¥Ï§òÏïº Ìï®

```
...
          # Provide the Skipper service location
          # kubectl describe service/skipper Ïã§Ìñâ ÌõÑ ÌëúÏãú ÎÇ¥Ïö© Ï§ë IP, PORT Í∞íÏùÑ ÏïÑÎûò value Ïóê ÏÑ§Ï†ï
        - name: SPRING_CLOUD_SKIPPER_CLIENT_SERVER_URI
          # value: 'http://${SKIPPER_SERVICE_HOST}:${SKIPPER_SERVICE_PORT}/api'
          value: 'http://10.96.89.15:80/api'
...
```

RabbitMQ Ïó∞ÎèôÏùÑ ÏúÑÌïú ConfigMap ÏùÄ `src/kubernetes/skipper/skipper-config-rabbit.yaml`Ïóê ÏûàÎã§Í≥† ÌïòÎäîÎç∞, Í∑∏Í±∏ Î≥µÏÇ¨Ìï¥ÏÑú Ï†ÅÏ†àÌûà Î∞îÍøîÏÑú `src/kubernetes/server/server-config-rabbit.yaml`Î°ú ÎßåÎì§Ïñ¥ Ïì∞ÎùºÎäî Í±¥ÏßÄ Í∑∏ÎÉ• ÏûàÎã§Îäî Í±¥ÏßÄ Ïïå Ïàò ÏóÜÏùå TODO

### ConfigMap ÏÉùÏÑ±

>kubectl create -f src/kubernetes/server/server-config.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/server-config.yaml
configmap/scdf-server created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Data Flow ÏÑúÎ≤Ñ Î∞∞Ìè¨

`src/kubernetes/server/server-svc.yaml`Î•º Ïó¥Ïñ¥Î≥¥Î©¥ Îã§ÏùåÍ≥º Í∞ôÏù¥ ÌÉÄÏûÖÏù¥ `LoadBalancer`Î°ú ÏßÄÏ†ïÎèº ÏûàÎäîÎç∞, Ïô∏Î∂Ä ÌÅ¥ÎùºÏö∞Îìú Ï†úÍ≥µÏûêÏùò Î°úÎìúÎ∞∏Îü∞ÏÑúÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏßÄ ÏïäÏúºÎØÄÎ°ú `LoadBalancer`Î•º `NodePort`Î°ú ÎåÄÏ≤¥ÌïúÎã§.

```
kind: Service                                                              
apiVersion: v1
metadata:
  name: scdf-server
  labels:
    app: scdf-server
    spring-deployment-id: scdf
spec:
  # If you are running k8s on a local dev box or using minikube, you can use type NodePort instead
  # type: LoadBalancer
  type: NodePort
  ports:
    - port: 80
      name: scdf-server
  selector:
    app: scdf-server
```

>kubectl create -f src/kubernetes/server/server-svc.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/server-svc.yaml
service/scdf-server created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

>kubectl create -f src/kubernetes/server/server-deployment.yaml

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl create -f src/kubernetes/server/server-deployment.yaml
deployment.apps/scdf-server created
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

### Data Flow ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÌôïÏù∏

>kubectl get all,cm -l app=scdf-server

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all,cm -l app=scdf-server
NAME                               READY   STATUS    RESTARTS   AGE
pod/scdf-server-5cdc56dd64-s494f   1/1     Running   0          91s

NAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/scdf-server   NodePort   10.96.177.217   <none>        80:31467/TCP   97s

NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/scdf-server   1/1     1            1           91s

NAME                                     DESIRED   CURRENT   READY   AGE
replicaset.apps/scdf-server-5cdc56dd64   1         1         1       91s

NAME                    DATA   AGE
configmap/scdf-server   1      108s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ  
```

podÏôÄ deployment Ïùò READY Ìï≠Î™©Ïù¥ `0/1`Î°ú ÌëúÏãúÎêòÎ©¥ ÎåÄÎûµ 1 ~ 2Î∂Ñ ÌõÑ Îã§Ïãú Ïã§ÌñâÌï¥ÏÑú `1/1`Î°ú ÌëúÏãúÎêòÎäî Í≤ÉÏùÑ ÌôïÏù∏Ìï¥Ïïº ÌïúÎã§.

### Data Flow ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÌöåÏàò

>kubectl delete all,cm -l app=scdf-server

### SCDF IP ÌôïÏù∏

>kubectl get svc scdf-server

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get svc scdf-server
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
scdf-server   NodePort   10.96.177.217   <none>        80:31467/TCP   5m26s
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```

`EXTERNAL_IP` Í∞íÏúºÎ°ú ÎÇòÏò® IPÎ°ú SCDF Shell ÏóêÏÑú Ï†ëÏÜç Í∞ÄÎä•

minikubeÎÇò kindÎ°ú Íµ¨ÏÑ±Ìïú Í≤ΩÏö∞ Ïô∏Î∂Ä Î°úÎìú Î∞∏Îü∞ÏÑúÎ•º Íµ¨ÏÑ±ÌïòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú `EXTERNAL_IP` Í∞íÏù¥ `<pending>`ÏúºÎ°ú ÌëúÏãúÎê®

minikubeÎ•º ÏÇ¨Ïö©ÌñàÎã§Î©¥ `minikube service --url scdf-server` Ïã§Ìñâ Í≤∞Í≥º ÎÇòÏò§Îäî IP, PORTÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎã§Í≥† ÌïúÎã§.

kindÎ•º ÏÇ¨Ïö©ÌñàÎã§Î©¥ Îã§Ïùå Î™ÖÎ†πÏúºÎ°ú URL ÌôïÏù∏ Í∞ÄÎä•

>TODO

# Ï†ÑÏ≤¥ ÏÑ§Ïπò ÎÇ¥Ïö© ÏµúÏ¢Ö ÌôïÏù∏

>kubectl get all,cm

```
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ kubectl get all,cm
NAME                                    READY   STATUS    RESTARTS   AGE
pod/grafana-7dc7d95456-bhj6l            1/1     Running   0          90m
pod/mysql-58f79dbc8c-n7slk              1/1     Running   0          5h36m
pod/prometheus-7fbc58dcf5-24bvv         1/1     Running   0          96m
pod/prometheus-proxy-5b958c7fd4-xk5lq   1/1     Running   0          5h26m
pod/rabbitmq-78b6c44c49-bpln4           1/1     Running   0          5h39m
pod/scdf-server-5cdc56dd64-s494f        1/1     Running   0          7m35s
pod/skipper-54d985cd5b-nd6wn            1/1     Running   0          45m

NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
service/grafana            NodePort    10.96.116.14    <none>        3000:30050/TCP                  90m
service/kubernetes         ClusterIP   10.96.0.1       <none>        443/TCP                         6h50m
service/mysql              ClusterIP   10.96.183.164   <none>        3306/TCP                        5h36m
service/prometheus         ClusterIP   10.96.87.216    <none>        9090/TCP                        95m
service/prometheus-proxy   NodePort    10.96.20.147    <none>        8080:32036/TCP,7001:31986/TCP   5h3m
service/rabbitmq           ClusterIP   10.96.135.124   <none>        5672/TCP                        5h39m
service/scdf-server        NodePort    10.96.177.217   <none>        80:31467/TCP                    7m41s
service/skipper            NodePort    10.96.89.15     <none>        80:31353/TCP                    25m

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana            1/1     1            1           90m
deployment.apps/mysql              1/1     1            1           5h36m
deployment.apps/prometheus         1/1     1            1           96m
deployment.apps/prometheus-proxy   1/1     1            1           5h26m
deployment.apps/rabbitmq           1/1     1            1           5h39m
deployment.apps/scdf-server        1/1     1            1           7m35s
deployment.apps/skipper            1/1     1            1           45m

NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/grafana-7dc7d95456            1         1         1       90m
replicaset.apps/mysql-58f79dbc8c              1         1         1       5h36m
replicaset.apps/prometheus-7fbc58dcf5         1         1         1       96m
replicaset.apps/prometheus-proxy-5b958c7fd4   1         1         1       5h26m
replicaset.apps/rabbitmq-78b6c44c49           1         1         1       5h39m
replicaset.apps/scdf-server-5cdc56dd64        1         1         1       7m35s
replicaset.apps/skipper-54d985cd5b            1         1         1       45m

NAME                    DATA   AGE
configmap/grafana       1      90m
configmap/prometheus    1      96m
configmap/scdf-server   1      7m52s
configmap/skipper       1      37m
üç∫ü¶ëüç∫üçïüç∫ ‚ùØ 
```



