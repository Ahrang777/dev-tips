# Gradle Multi Module Project Kotlin Spring Boot Upgrade

buildSrc 폴더를 사용하는 Gradle 멀티 모듈 프로젝트에서 코틀린 버전을 업그레이드 해보자.

buildSrc 폴더를 사용하지 않는 경우에는 그냥 build.gradle.kts 파일에서 아래와 같이 kotlin-gradle-plugin의 버전만 명시해주면 된다고 하는데,

```
// build.gradle.kts

dependencies {
    implementation("org.jetbrains.kotlin:kotlin-gradle-plugin:1.7.20")
    implementation(kotlin("script-runtime"))
}
```

buildSrc 폴더를 사용하는 경우에는 그리 간단하지가 않더라능.


## buildSrc

```kotlin
// buildSrc/build.gradle.kts

/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    // Support convention plugins written in Kotlin. Convention plugins are build scripts in 'src/main' that automatically become available as plugins in the main build.
    `kotlin-dsl`
}

repositories {
    // Use the plugin portal to apply community plugins in convention plugins.
    gradlePluginPortal()
}

extra["kotlinVersion"] = "1.7.20"

dependencies {
    implementation("org.jetbrains.kotlin:kotlin-gradle-plugin:${property("kotlinVersion")}")
    implementation(kotlin("script-runtime"))
}

```

위와 같이 kotlin-gradle-plugin 의 버전만 1.7.20 으로 명시해주면 그냥 될 것 같지만 kotlin-gradle-plugin 의 버전을 명시하면 대략 아래와 같은 에러 중의 하나가 발생하고, 검색해서 이것저것 하다보면 또 아래 에러 중 다른 에러가 나면서 금방 해결은 안 된다.


>- Invalid plugin request [id: ‘org.jetbrains.kotlin.jvm’, version: ‘1.7.20’]. Plugin requests from precompiled scripts must not include a version number. Please remove the version from the offending request and make sure the module containing the requested plugin ‘org.jetbrains.kotlin.jvm’ is an implementation dependency of project ‘:buildSrc’.

>- plugin request for plugin already on the classpath must not include a version

>- java.lang.String org.jetbrains.kotlin.gradle.plugin.KotlinPluginWrapper.getKotlinPluginVersion()


버전을 명시하면 안 된다거나, 뭔가 kotlin plugin version 을 읽을 수 있는 `getKotlinPluginVersion()`가 없다는 얘기 같다.

검색하다보니 https://youtrack.jetbrains.com/issue/KT-52790/Gradle-multi-module-NoSuchMethodError-KotlinPluginWrappergetKotlinPluginVersion#focus=Comments-27-6185693.0-0 이런 게 있고 Spring Boot 버전과 플러그인 버전을 올리면 된다는 얘기 같다. 해보자.


## Spring Boot 업그레이드

정확하진 않지만 2.7 부터 위에서 말한 문제를 해결해주는 게 아닐까 싶다.  
일단 현재 최신 릴리스 버전인 2.7.4 로 시도해본다.

```kotlin
// submodule/build.gradle.kts

plugins {    
    id("org.springframework.boot") version "2.7.4"
    id("io.spring.dependency-management") version "1.0.14.RELEASE"

    kotlin("kapt")  // querydsl 사용하는 경우 필요
    kotlin("plugin.spring") version "1.7.20"
    kotlin("plugin.jpa") version "1.7.20"
    // 기타 생략
}

extra["kotlinVersion"] = "1.7.20"

dependencies {
    implementation("org.jetbrains.kotlin:kotlin-reflect:${property("kotlinVersion")}")
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8:${property("kotlinVersion")}")
    // 기타 생략
}
```

정말 스프링 부트와 플러그인 버전을 올리니까 된다!!

그럼 스프링을 사용하지 않으면서 buildSrc 폴더를 사용하는 Gradle 멀티 모듈 프로젝트의 코틀린 언어 버전 업그레이드는 어떻게 하나?

몰라. 끗.




